# Development Environment Template
# Complete development setup with common tools and IDE
# Optimized for software development workflows

name: dev-template
arch: "x86_64"
images:
  - location: "https://cloud-images.ubuntu.com/jammy/current/jammy-server-cloudimg-amd64.img"
    arch: "x86_64"
    digest: "sha256:1234567890abcdef1234567890abcdef1234567890abcdef1234567890abcdef"

# Resource allocation - balanced for development
cpus: 1
memory: "2GiB"
disk: "15GiB"

# Mount host directories for development
mounts:
  - location: "~/.lima/dev/{{.Name}}/workspace"
    writable: true
    mountPoint: /home/devuser/workspace
  - location: "~/.lima/dev/{{.Name}}/data"
    writable: true
    mountPoint: /data
  - location: "~/.lima/dev/{{.Name}}/projects"
    writable: true
    mountPoint: /projects

# SSH configuration with agent forwarding for Git
ssh:
  localPort: 0
  loadDotSSHPubKeys: true
  forwardAgent: true
  forwardX11: false

# Container runtime configuration
containerd:
  system: true
  user: true

# Port forwarding for development services
portForwards:
  - guestPort: 22
    hostPort: 2222
    proto: "tcp"   # SSH
  - guestPort: 3000
    hostPort: 3000
    proto: "tcp"   # Development servers
  - guestPort: 8080
    hostPort: 8080
    proto: "tcp"   # Web applications
  - guestPort: 5173
    hostPort: 5173
    proto: "tcp"   # Vite dev server
  - guestPort: 8000
    hostPort: 8000
    proto: "tcp"   # Django/Flask dev server

# Network configuration
networks:
  - lima: shared

# Provisioning scripts
provision:
  # System-level provisioning
  - mode: system
    script: |
      #!/bin/bash
      set -eux -o pipefail
      
      export DEBIAN_FRONTEND=noninteractive
      apt-get update
      apt-get upgrade -y
      
      # Install essential development tools
      apt-get install -y \
        curl \
        wget \
        git \
        git-lfs \
        vim \
        nano \
        tmux \
        zsh \
        fish \
        htop \
        tree \
        jq \
        yq \
        httpie \
        ncdu \
        rsync \
        zip \
        unzip \
        tar \
        gzip \
        build-essential \
        cmake \
        pkg-config \
        autoconf \
        automake \
        libtool \
        make \
        gcc \
        g++ \
        clang \
        clang-format \
        gdb \
        valgrind \
        strace \
        ltrace \
        net-tools \
        iputils-ping \
        dnsutils \
        traceroute \
        mtr \
        tcpdump \
        nmap \
        socat \
        netcat \
        openssh-server \
        fail2ban \
        ufw \
        ca-certificates \
        gnupg2 \
        pass \
        xclip \
        fzf \
        ripgrep \
        bat \
        exa \
        fd \
        delta \
        tldr \
        neofetch \
        cowsay \
        figlet \
        lolcat
      
      # Configure firewall
      ufw --force enable
      ufw allow ssh
      ufw allow 22
      ufw allow 3000
      ufw allow 8080
      ufw allow 5173
      ufw allow 8000
      
      # Create development user
      useradd -m -s /bin/zsh devuser || true
      usermod -aG docker devuser
      usermod -aG sudo devuser
      
      # Set up passwordless sudo for devuser
      echo "devuser ALL=(ALL) NOPASSWD:ALL" > /etc/sudoers.d/devuser
      
      # Create development directories
      mkdir -p /home/devuser/workspace /home/devuser/projects /data /projects
      chown -R devuser:devuser /home/devuser /data /projects
      
      # Install Oh My Zsh
      runuser -l devuser -c 'sh -c "$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)" "" --unattended'
      
      # Install useful Zsh plugins
      runuser -l devuser -c 'git clone https://github.com/zsh-users/zsh-autosuggestions ${ZSH_CUSTOM:-~/.oh-my-zsh/custom}/plugins/zsh-autosuggestions'
      runuser -l devuser -c 'git clone https://github.com/zsh-users/zsh-syntax-highlighting.git ${ZSH_CUSTOM:-~/.oh-my-zsh/custom}/plugins/zsh-syntax-highlighting'
      runuser -l devuser -c 'git clone https://github.com/zsh-users/zsh-completions ${ZSH_CUSTOM:-~/.oh-my-zsh/custom}/plugins/zsh-completions'
      
      # Configure Zsh
      cat > /home/devuser/.zshrc << 'EOF'
      export ZSH="$HOME/.oh-my-zsh"
      ZSH_THEME="agnoster"
      plugins=(git zsh-autosuggestions zsh-syntax-highlighting zsh-completions docker docker-compose kubectl)
      source $ZSH/oh-my-zsh.sh
      
      # User configuration
      export EDITOR=vim
      export VISUAL=vim
      export PAGER=less
      export LESS="-R -F -X"
      
      # Path
      export PATH="$HOME/.local/bin:$PATH"
      export PATH="$HOME/go/bin:$PATH"
      export PATH="$HOME/.cargo/bin:$PATH"
      export PATH="$PATH:/usr/local/go/bin"
      
      # Go
      export GOPATH="$HOME/go"
      export GO111MODULE="on"
      
      # Node.js
      export N_PREFIX="$HOME/.n"
      export PATH="$N_PREFIX/bin:$PATH"
      
      # Python
      export PYENV_ROOT="$HOME/.pyenv"
      export PATH="$PYENV_ROOT/bin:$PATH"
      eval "$(pyenv init --path)"
      eval "$(pyenv virtualenv-init -)"
      
      # Rust
      export CARGO_HOME="$HOME/.cargo"
      export RUSTUP_HOME="$HOME/.rustup"
      source "$CARGO_HOME/env"
      
      # Aliases
      alias ll='exa -alF'
      alias la='exa -A'
      alias l='exa -CF'
      alias lt='exa --tree'
      alias cat='bat'
      alias grep='rg'
      alias find='fd'
      alias top='htop'
      alias vim='nvim'
      alias python='python3'
      alias pip='pip3'
      alias k='kubectl'
      alias d='docker'
      alias dc='docker-compose'
      alias g='git'
      alias gs='git status'
      alias gd='git diff'
      alias gc='git commit'
      alias gp='git push'
      alias gl='git pull'
      alias ga='git add'
      alias gb='git branch'
      alias gco='git checkout'
      
      # Functions
      mkcd() {
        mkdir -p "$1" && cd "$1"
      }
      
      cdf() {
        cd "$(find . -type d -print | fzf)"
      }
      
      # History settings
      HISTSIZE=10000
      SAVEHIST=10000
      HIST_STAMPS="mm/dd/yyyy"
      
      # Auto-completion
      autoload -U compinit && compinit
      
      # Auto-cd
      setopt AUTO_CD
      
      # Enable colors
      export TERM=xterm-256color
      
      # Welcome message
      neofetch
      EOF
      
      chown devuser:devuser /home/devuser/.zshrc
      
      # Install and configure Git
      runuser -l devuser -c 'git config --global user.name "Developer"'
      runuser -l devuser -c 'git config --global user.email "dev@example.com"'
      runuser -l devuser -c 'git config --global init.defaultBranch main'
      runuser -l devuser -c 'git config --global core.editor "vim"'
      runuser -l devuser -c 'git config --global pull.rebase true'
      runuser -l devuser -c 'git config --global credential.helper store'
      runuser -l devuser -c 'git lfs install'
      
      # Install Docker
      apt-get install -y containerd
      mkdir -p /etc/containerd
      containerd config default > /etc/containerd/config.toml
      sed -i 's/SystemdCgroup = false/SystemdCgroup = true/' /etc/containerd/config.toml
      systemctl restart containerd
      systemctl enable containerd
      
      # Install Docker Compose
      curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
      chmod +x /usr/local/bin/docker-compose
      
      # Install nerdctl
      curl -sSL https://github.com/containerd/nerdctl/releases/download/v1.7.0/nerdctl-1.7.0-linux-amd64.tar.gz | tar -xz -C /usr/local/bin

  # Install programming languages and runtimes
  - mode: system
    script: |
      #!/bin/bash
      set -eux -o pipefail
      
      # Install Python
      apt-get install -y python3 python3-pip python3-venv python3-dev python3-pytest python3-black python3-flake8
      
      # Install Node.js
      curl -fsSL https://deb.nodesource.com/setup_20.x | bash -
      apt-get install -y nodejs
      
      # Install global npm packages
      npm install -g npm@latest
      npm install -g yarn pnpm typescript ts-node nodemon pm2 @vue/cli @angular/cli create-react-app next
      
      # Install Go
      wget https://golang.org/dl/go1.21.0.linux-amd64.tar.gz
      tar -C /usr/local -xzf go1.21.0.linux-amd64.tar.gz
      rm go1.21.0.linux-amd64.tar.gz
      
      # Install Java
      apt-get install -y openjdk-17-jdk maven gradle
      
      # Install Rust
      curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
      source /home/devuser/.cargo/env
      
      # Install Ruby
      apt-get install -y ruby-full ruby-bundler
      
      # Install PHP
      apt-get install -y php php-cli php-fpm php-mbstring php-xml php-curl php-zip php-gd php-mysql php-sqlite3
      
      # Install Composer
      curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer
      
      # Install .NET
      wget https://packages.microsoft.com/config/ubuntu/20.04/packages-microsoft-prod.deb -O packages-microsoft-prod.deb
      dpkg -i packages-microsoft-prod.deb
      apt-get update
      apt-get install -y dotnet-sdk-7.0
      
      # Install Deno
      curl -fsSL https://deno.land/install.sh | sh
      
      # Install Bun
      curl -fsSL https://bun.sh/install | bash
      
      # Install additional tools
      apt-get install -y postgresql-client mysql-client sqlite3 redis-tools
      
      # Install kubectl
      curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
      install -o root -g root -m 0755 kubectl /usr/local/bin/kubectl
      
      # Install Helm
      curl https://baltocdn.com/helm/signing.asc | gpg --dearmor | tee /usr/share/keyrings/helm.gpg > /dev/null
      echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/helm.gpg] https://baltocdn.com/helm/stable/debian/ all main" | tee /etc/apt/sources.list.d/helm-stable-debian.list
      apt-get update
      apt-get install -y helm
      
      # Install Terraform
      wget -O- https://apt.releases.hashicorp.com/gpg | gpg --dearmor | tee /usr/share/keyrings/hashicorp-archive-keyring.gpg > /dev/null
      echo "deb [signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com $(lsb_release -cs) main" | tee /etc/apt/sources.list.d/hashicorp.list
      apt-get update && apt-get install -y terraform
      
      # Install Ansible
      apt-get install -y ansible
      
      # Install Vagrant
      wget -O- https://apt.releases.hashicorp.com/gpg | gpg --dearmor | tee /usr/share/keyrings/hashicorp-archive-keyring.gpg
      echo "deb [signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com $(lsb_release -cs) main" | tee /etc/apt/sources.list.d/hashicorp.list
      apt-get update && apt-get install -y vagrant

  # Install development tools and IDEs
  - mode: system
    script: |
      #!/bin/bash
      set -eux -o pipefail
      
      # Install VS Code Server
      curl -fsSL https://code-server.dev/install.sh | sh
      
      # Configure VS Code Server
      mkdir -p /home/devuser/.config/code-server
      cat > /home/devuser/.config/code-server/config.yaml << 'EOF'
      bind-addr: 0.0.0.0:8080
      auth: password
      password: devpassword
      cert: false
      EOF
      
      chown -R devuser:devuser /home/devuser/.config
      
      # Install JupyterLab
      pip3 install jupyterlab
      
      # Configure JupyterLab
      mkdir -p /home/devuser/.jupyter
      cat > /home/devuser/.jupyter/jupyter_lab_config.py << 'EOF'
      c.ServerApp.ip = '0.0.0.0'
      c.ServerApp.port = 8888
      c.ServerApp.open_browser = False
      c.ServerApp.allow_root = True
      c.ServerApp.token = ''
      c.ServerApp.password = 'devpassword'
      EOF
      
      chown -R devuser:devuser /home/devuser/.jupyter
      
      # Install Docker development tools
      runuser -l devuser -c 'mkdir -p ~/.docker/cli-plugins'
      runuser -l devuser -c 'curl -sSL https://github.com/docker/compose/releases/download/v2.20.0/docker-compose-linux-x86_64 -o ~/.docker/cli-plugins/docker-compose'
      runuser -l devuser -c 'chmod +x ~/.docker/cli-plugins/docker-compose'
      
      # Install lazydocker
      curl https://raw.githubusercontent.com/jesseduffield/lazydocker/master/scripts/install_update_linux.sh | bash
      
      # Install lazygit
      LAZYGIT_VERSION="0.39.1"
      curl -Lo lazygit.tar.gz "https://github.com/jesseduffield/lazygit/releases/download/v${LAZYGIT_VERSION}/lazygit_${LAZYGIT_VERSION}_Linux_x86_64.tar.gz"
      tar xf lazygit.tar.gz lazygit
      install lazygit /usr/local/bin
      rm lazygit.tar.gz lazygit

  # User-level provisioning
  - mode: user
    script: |
      #!/bin/bash
      set -eux -o pipefail
      
      # Install pyenv
      curl https://pyenv.run | bash
      
      # Install n (Node version manager)
      curl -L https://git.io/n-install | bash
      
      # Install SDKMAN for Java tools
      curl -s "https://get.sdkman.io" | bash
      
      # Install rbenv
      git clone https://github.com/rbenv/rbenv.git ~/.rbenv
      git clone https://github.com/rbenv/ruby-build.git ~/.rbenv/plugins/ruby-build
      
      # Install tfenv (Terraform version manager)
      git clone --depth=1 https://github.com/tfutils/tfenv.git ~/.tfenv
      
      # Install k9s (Kubernetes CLI)
      wget https://github.com/derailed/k9s/releases/latest/download/k9s_Linux_amd64.tar.gz
      tar -xzf k9s_Linux_amd64.tar.gz
      install k9s /usr/local/bin/
      rm k9s_Linux_amd64.tar.gz k9s
      
      # Install stern (Kubernetes log tailer)
      stern_url=$(curl -s https://api.github.com/repos/stern/stern/releases/latest | grep browser_download_url | grep linux_amd64 | cut -d '"' -f 4)
      wget $stern_url -O stern
      install stern /usr/local/bin/
      rm stern
      
      # Install gh (GitHub CLI)
      type -p curl >/dev/null || (sudo apt update && sudo apt-get install curl -y)
      curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
      echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
      sudo apt update
      sudo apt install gh -y
      
      # Install AWS CLI
      curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
      unzip awscliv2.zip
      sudo ./aws/install
      rm awscliv2.zip aws
      
      # Install Azure CLI
      curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash
      
      # Install Google Cloud SDK
      echo "deb [signed-by=/usr/share/keyrings/cloud.google.gpg] https://packages.cloud.google.com/apt cloud-sdk main" | sudo tee -a /etc/apt/sources.list.d/google-cloud-sdk.list
      sudo apt-get install -y apt-transport-https ca-certificates gnupg
      curl https://packages.cloud.google.com/apt/doc/apt-key.gpg | sudo apt-key --keyring /usr/share/keyrings/cloud.google.gpg add
      sudo apt-get update && sudo apt-get install -y google-cloud-sdk
      
      # Create development workspace structure
      mkdir -p ~/workspace/{personal,work,learning,experiments}
      mkdir -p ~/projects/{active,archived,templates}
      
      # Create useful scripts
      cat > ~/bin/dev-setup << 'EOF'
      #!/bin/bash
      echo "Setting up development environment..."
      
      # Create new project
      if [ "$1" = "new" ]; then
        PROJECT_TYPE="$2"
        PROJECT_NAME="$3"
        
        if [ -z "$PROJECT_TYPE" ] || [ -z "$PROJECT_NAME" ]; then
          echo "Usage: dev-setup new <type> <name>"
          echo "Types: node, python, go, rust, java, web, react, vue"
          exit 1
        fi
        
        PROJECT_DIR="$HOME/workspace/$PROJECT_NAME"
        mkdir -p "$PROJECT_DIR"
        cd "$PROJECT_DIR"
        
        case $PROJECT_TYPE in
          node)
            npm init -y
            echo "Node.js project created in $PROJECT_DIR"
            ;;
          python)
            python3 -m venv venv
            source venv/bin/activate
            pip install --upgrade pip
            echo "Python project created in $PROJECT_DIR"
            ;;
          go)
            go mod init "$PROJECT_NAME"
            echo "Go project created in $PROJECT_DIR"
            ;;
          rust)
            cargo init
            echo "Rust project created in $PROJECT_DIR"
            ;;
          java)
            mvn archetype:generate -DgroupId=com.example -DartifactId="$PROJECT_NAME" -DarchetypeArtifactId=maven-archetype-quickstart -DinteractiveMode=false
            echo "Java project created in $PROJECT_DIR"
            ;;
          web)
            echo '<!DOCTYPE html>
      <html>
      <head>
          <title>'"$PROJECT_NAME"'</title>
      </head>
      <body>
          <h1>Welcome to '"$PROJECT_NAME"'</h1>
      </body>
      </html>' > index.html
            echo "Web project created in $PROJECT_DIR"
            ;;
          react)
            npx create-react-app "$PROJECT_NAME"
            echo "React project created in $PROJECT_DIR"
            ;;
          vue)
            npx create-vue@latest "$PROJECT_NAME"
            echo "Vue project created in $PROJECT_DIR"
            ;;
          *)
            echo "Unknown project type: $PROJECT_TYPE"
            exit 1
            ;;
        esac
        
        git init
        echo "# $PROJECT_NAME" > README.md
        git add .
        git commit -m "Initial commit"
        
        echo "Project '$PROJECT_NAME' created successfully!"
        echo "Location: $PROJECT_DIR"
      fi
      EOF
      
      chmod +x ~/bin/dev-setup
      
      # Create .gitignore template
      cat > ~/.gitignore_global << 'EOF'
      # OS generated files
      .DS_Store
      .DS_Store?
      ._*
      .Spotlight-V100
      .Trashes
      ehthumbs.db
      Thumbs.db
      
      # IDE
      .vscode/
      .idea/
      *.swp
      *.swo
      *~
      
      # Dependencies
      node_modules/
      vendor/
      venv/
      .venv/
      env/
      .env
      
      # Build outputs
      dist/
      build/
      target/
      out/
      
      # Logs
      *.log
      logs/
      
      # Runtime data
      pids/
      *.pid
      *.seed
      *.pid.lock
      
      # Coverage directory used by tools like istanbul
      coverage/
      .coverage
      
      # Temporary folders
      tmp/
      temp/
      
      # Docker
      .dockerignore
      docker-compose.override.yml
      
      # Kubernetes
      *.kubeconfig
      
      # Terraform
      *.tfstate
      *.tfstate.*
      .terraform/
      
      # Python
      __pycache__/
      *.py[cod]
      *$py.class
      *.so
      .Python
      build/
      develop-eggs/
      dist/
      downloads/
      eggs/
      .eggs/
      lib/
      lib64/
      parts/
      sdist/
      var/
      wheels/
      *.egg-info/
      .installed.cfg
      *.egg
      
      # Go
      /bin/
      /pkg/
      *.exe
      *.exe~
      *.dll
      *.so
      *.dylib
      /test/
      
      # Rust
      /target/
      Cargo.lock
      
      # Node.js
      npm-debug.log*
      yarn-debug.log*
      yarn-error.log*
      .npm
      .node_repl_history
      .eslintcache
      
      # Java
      *.class
      *.jar
      *.war
      *.ear
      .gradle/
      build/
      
      # DotEnv
      .env
      .env.local
      .env.development.local
      .env.test.local
      .env.production.local
      
      # Database
      *.db
      *.sqlite
      *.sqlite3
      
      # Secrets
      .secrets/
      secrets/
      *.key
      *.pem
      *.p12
      *.pfx
      
      # Backup files
      *.bak
      *.backup
      EOF
      
      runuser -l devuser -c 'git config --global core.excludesfile ~/.gitignore_global'

# Health checks
probes:
  - mode: readiness
    description: Check containerd
    script: |
      #!/bin/bash
      systemctl is-active --quiet containerd
  - mode: readiness
    description: Check development user
    script: |
      #!/bin/bash
      id devuser >/dev/null 2>&1
  - mode: readiness
    description: Check Docker
    script: |
      #!/bin/bash
      docker info >/dev/null 2>&1

# Message for users
message: |
  Development environment template has been successfully created!
  
  Features included:
  - Ubuntu 22.04 LTS
  - Multiple programming languages (Python, Node.js, Go, Rust, Java, PHP, Ruby, .NET)
  - Development tools (Git, Docker, kubectl, Terraform, Ansible)
  - IDEs (VS Code Server, JupyterLab)
  - Package managers and version managers
  - Container runtime and orchestration tools
  - Cloud CLI tools (AWS, Azure, GCP)
  - Zsh with useful plugins and aliases
  - Development workspace structure
  
  Quick start:
  1. SSH into the VM:
      ssh -p 2222 devuser@localhost
  
  2. Access VS Code Server:
      http://localhost:8080
      Password: devpassword
  
  3. Access JupyterLab:
      http://localhost:8888
      Password: devpassword
  
  4. Create new project:
      dev-setup new <type> <name>
      Types: node, python, go, rust, java, web, react, vue
  
  5. Start development server:
      # For Node.js
      npm start
      # For Python
      python -m http.server 8000
      # For Go
      go run main.go
  
  Available ports:
  - SSH: 2222
  - Development servers: 3000, 8080, 5173, 8000
  
  Happy coding! ðŸš€